# Aave Lite Testnet

Минималистичный интерфейс для взаимодействия с протоколом Aave V3 на тестовой сети Sepolia.

## Что это?

Веб-приложение позволяет:
- **Deposit (Депозит)** - вносить токены в Aave для получения процентов
- **Withdraw (Вывод)** - выводить свои депозиты
- **Borrow (Займ)** - брать токены в долг под залог депозита
- **Repay (Погашение)** - погашать займы

## Поддерживаемые токены

На Aave Sepolia работают следующие токены:
- **LINK** - Chainlink Token
- **WBTC** - Wrapped Bitcoin
- **AAVE** - Aave Token

> **Внимание:** DAI и USDC на Aave Sepolia временно заморожены (ошибка 51 - RESERVE_INACTIVE)

## Технологии

- **React 18** + **TypeScript**
- **Vite** - сборщик
- **wagmi v2** + **viem** - работа с блокчейном
- **RainbowKit** - подключение кошелька
- **Tailwind CSS** - стили
- **shadcn/ui** - UI компоненты
- **Vitest** - юнит тесты
- **Playwright** + **Synpress** - E2E тесты с MetaMask

---

## Быстрый старт

### 1. Клонирование и установка

```bash
git clone <repo-url>
cd aave-lite-testnet
npm install
```

### 2. Настройка окружения

Создайте файл `.env` в корне проекта:

```env
# Seed фраза тестового кошелька (только для E2E тестов!)
SEED_PHRASE="your twelve word seed phrase here for testing only"
```

> **ВАЖНО:** Используйте ТОЛЬКО тестовый кошелёк! Никогда не используйте основной кошелёк.

### 3. Получение тестовых токенов

1. Получите Sepolia ETH для газа: https://sepoliafaucet.com/
2. Получите тестовые LINK: https://faucets.chain.link/sepolia
3. Получите тестовые токены Aave: https://staging.aave.com/faucet/

### 4. Запуск приложения

```bash
npm run dev
```

Откройте http://localhost:5173 в браузере.

---

## Использование приложения

### Подключение кошелька

1. Нажмите "Connect Wallet"
2. Выберите MetaMask
3. Подтвердите подключение
4. Переключитесь на сеть Sepolia (если попросит)

### Депозит токенов

1. В разделе "Your tokens" найдите нужный токен (LINK, WBTC, AAVE)
2. Нажмите "Deposit"
3. Введите сумму или нажмите "Max"
4. Нажмите "Approve & Deposit" (первый раз нужен approve)
5. Подтвердите транзакции в MetaMask
6. Дождитесь подтверждения

### Вывод токенов

1. В таблице "Your Supplies" найдите позицию
2. Нажмите "Withdraw"
3. Введите сумму
4. Подтвердите транзакцию

### Займ токенов

1. Сначала сделайте депозит (это будет залог)
2. В форме "Borrow" выберите токен
3. Введите сумму (не больше доступного лимита)
4. Подтвердите транзакцию

### Погашение займа

1. В таблице "Your Borrows" найдите позицию
2. Нажмите "Repay"
3. Введите сумму
4. Нажмите "Approve & Repay"
5. Подтвердите транзакции

---

## Тестирование

### Юнит тесты

Запуск всех юнит тестов:
```bash
npm run test:run
```

Запуск в watch режиме:
```bash
npm run test
```

Юнит тесты покрывают:
- `useDeposit` - хук депозита
- `useWithdraw` - хук вывода
- `useBorrow` - хук займа/погашения
- `DepositForm` - компонент формы депозита
- `WithdrawForm` - компонент формы вывода

### E2E тесты (с MetaMask)

E2E тесты используют Synpress v4 для автоматизации MetaMask.

#### Требования

- Node.js 18+
- Установленный Chromium (устанавливается автоматически)
- Тестовый кошелёк с токенами на Sepolia

#### Настройка

1. Убедитесь что `.env` содержит `SEED_PHRASE`
2. На кошельке должны быть:
   - Sepolia ETH для газа
   - LINK токены для тестов

#### Запуск E2E тестов

Запуск всех E2E тестов:
```bash
npm run test:e2e
```

Запуск конкретной группы тестов:
```bash
# Только тесты депозита
npm run test:e2e -- --grep "Deposit"

# Только тесты вывода
npm run test:e2e -- --grep "Withdraw"

# Только тесты займа
npm run test:e2e -- --grep "Borrow"

# Только тесты погашения
npm run test:e2e -- --grep "Repay"
```

#### Что тестируется (23 теста)

| Группа | Тесты | Описание |
|--------|-------|----------|
| Connection | 2 | Подключение кошелька |
| Token Balances | 2 | Отображение балансов |
| Deposit Flow | 4 | Полный флоу депозита LINK и WBTC |
| Positions | 2 | Отображение позиций |
| Withdraw Flow | 3 | Вывод токенов |
| Borrow Flow | 3 | Займ токенов |
| Repay Flow | 2 | Погашение займов |
| Account Overview | 2 | Обзор аккаунта |
| Error Handling | 2 | Обработка ошибок |

#### Просмотр отчёта

После запуска тестов:
```bash
npx playwright show-report
```

---

## Структура проекта

```
aave-lite-testnet/
├── src/
│   ├── components/          # React компоненты
│   │   ├── ui/              # shadcn/ui компоненты
│   │   ├── DepositForm.tsx  # Форма депозита
│   │   ├── WithdrawForm.tsx # Форма вывода
│   │   ├── BorrowForm.tsx   # Форма займа
│   │   ├── RepayForm.tsx    # Форма погашения
│   │   └── ...
│   ├── hooks/               # React хуки
│   │   ├── useDeposit.ts    # Логика депозита
│   │   ├── useWithdraw.ts   # Логика вывода
│   │   ├── useBorrow.ts     # Логика займа/погашения
│   │   ├── usePositions.ts  # Позиции пользователя
│   │   └── ...
│   ├── config/              # Конфигурация
│   │   └── contracts.ts     # Адреса контрактов и ABI
│   └── utils/               # Утилиты
├── e2e/                     # E2E тесты
│   └── aave.spec.ts         # Тесты с MetaMask
├── .env                     # Переменные окружения
└── package.json
```

---

## Скрипты

| Команда | Описание |
|---------|----------|
| `npm run dev` | Запуск dev сервера |
| `npm run build` | Сборка для продакшена |
| `npm run preview` | Просмотр сборки |
| `npm run test` | Юнит тесты (watch) |
| `npm run test:run` | Юнит тесты (однократно) |
| `npm run test:e2e` | E2E тесты |
| `npm run lint` | Проверка линтером |

---

## Особенности реализации

### Автоматический Approve + Deposit/Repay

При недостаточном allowance автоматически:
1. Запрашивается approve
2. После подтверждения сразу выполняется deposit/repay

### Дедупликация тостов

Используется `useRef<Set<string>>` для отслеживания показанных уведомлений по hash транзакции, чтобы избежать дублирования.

### Отслеживание статуса транзакции

Проверяется `receipt.status === 'success'` для определения успеха транзакции, а не только `isSuccess` от wagmi.

### Auto-select токена в RepayForm

Если у пользователя нет долга по выбранному токену, автоматически выбирается первый токен с долгом.

---

## Troubleshooting

### "Reserve is inactive" (Error 51)

DAI и USDC заморожены на Aave Sepolia. Используйте LINK, WBTC или AAVE.

### Транзакция зависла

1. Проверьте что достаточно ETH для газа
2. Попробуйте увеличить газ в MetaMask
3. Отмените транзакцию и повторите

### Тесты падают

1. Убедитесь что `SEED_PHRASE` корректная
2. Проверьте баланс тестовых токенов
3. Запустите `npx playwright install` для обновления браузеров

